`多言語対応-完全設計.md`の内容を確認して、「単純な翻訳辞書の置き換えでは済まない」複雑さを整理します。

[1 tool called]

ドキュメントを確認しました。「単純に翻訳辞書を用意してテキストを置き換えるだけでは済まない」複雑さを整理します。

---

## 😰 やらかしポイント：日本語→多言語対応の本当の難しさ

### ❌ 甘く見ていた現実

「UIのテキストを全部抽出して翻訳辞書作ればいいんでしょ？」と思っていたが、実際は **7つのフェーズ、数十のタスク** が発生した。

---

### 1️⃣ UIテキストだけじゃない！4種類のコンテンツが存在

| コンテンツタイプ | 例 | 翻訳方法 | 難易度 |
|-----------------|-----|---------|--------|
| **UIテキスト** | ボタン、ラベル、エラーメッセージ | JSONファイル（next-intl） | ⭐ |
| **マスターデータ** | カード名「ピカチュウex」、パック名 | DBに事前格納 | ⭐⭐⭐ |
| **管理者コンテンツ** | デッキガイド、記事、大会情報 | DBに多言語カラム追加 | ⭐⭐⭐ |
| **ユーザー生成コンテンツ** | コメント、トレード投稿、デッキ説明 | リアルタイム翻訳API | ⭐⭐⭐⭐⭐ |

**やらかし**: UIテキストの翻訳だけで終わると思っていた

---

### 2️⃣ データベーススキーマの大改修が必要

**最初の設計**:
```sql
-- 日本語専用で設計していた
CREATE TABLE cards (
  id BIGINT PRIMARY KEY,
  name TEXT NOT NULL,  -- ← 日本語しか入らない
  image_url TEXT NOT NULL
);
```

**必要になった変更**:
```sql
-- 13テーブルに48カラムのJSONB追加
ALTER TABLE cards ADD COLUMN name_multilingual JSONB;
-- {"ja": "ピカチュウex", "en": "Pikachu ex", "ko": "피카츄 ex", ...}

-- 26個のGINインデックス作成（検索性能のため）
CREATE INDEX idx_cards_name_multilingual ON cards USING GIN(name_multilingual);
```

**やらかし**: 
- 最初から多言語を見据えたスキーマ設計をしていなかった
- 後からの変更で、149,000件以上のトレード投稿データのマイグレーションが発生

---

### 3️⃣ 既存データのマイグレーション地獄

```
実際に必要だった作業量:
├── cards: 2,259件 → 7言語分のカード名をCSVからインポート
├── packs: 18件 → パック名の多言語化
├── deck_pages: 8件 → 17カラム×8件の翻訳
├── trade_posts: 149,862件 → JSONBカラムへの変換
├── info_article_blocks: 9件 → 記事ブロックの翻訳
└── その他多数...
```

**やらかし**: 「あとでやればいい」と思っていたら、データ量が増えすぎて地獄

---

### 4️⃣ カード名は翻訳APIでは正確に訳せない

**問題**:
```
入力: 「リザードンexが欲しいです」
Google翻訳の結果: "I want a Lizard ex" ← ❌ 誤訳！
正しい結果: "I want a Charizard ex" ← ✅
```

**解決策**: カード名辞書を別途作成し、翻訳後に置換する処理が必要

```typescript
// lib/translation.ts - カード名置換機能
export async function replaceCardNames(
  text: string,
  targetLanguage: string,
  supabase: any
): Promise<string> {
  const dictionary = await getCardNameDictionary(supabase);
  // 「ピカチュウex」→「Pikachu ex」に置換
  dictionary.forEach((translations, jaName) => {
    result = result.replace(jaName, translations[targetLanguage]);
  });
  return result;
}
```

**やらかし**: 「翻訳APIに投げれば全部解決」と思っていた

---

### 5️⃣ ユーザー生成コンテンツはリアルタイム翻訳が必要

**UIテキスト**は事前に翻訳JSONを用意できるが、**ユーザーが書いたコメント**はそうはいかない。

```
必要になったもの:
├── Google Cloud Translate API連携
├── 翻訳キャッシュテーブル（同じ文を何度も翻訳しないため）
├── 翻訳ジョブキュー（バックグラウンド処理）
├── 翻訳ボタンUI（「翻訳する」ボタン）
└── エラーハンドリング（API制限、タイムアウト）
```

**やらかし**: 
- 翻訳APIには利用申請が必要で、3営業日待ちが発生
- 翻訳コスト（$20/100万文字）の見積もりが甘かった

---

### 6️⃣ URLルーティングの変更

**Before**: `/matching`, `/trades/123`

**After**: `/ja/matching`, `/en/trades/123`

```typescript
// middleware.ts の追加が必要
export default createMiddleware({
  locales: ['ja', 'en', 'zh-cn', 'zh-tw', 'ko', 'fr', 'es', 'de'],
  defaultLocale: 'ja',
  localePrefix: 'always',
});

// 全てのリンクを書き換え
<Link href="/trades">  →  <Link href={`/${locale}/trades`}>
```

**やらかし**: 
- 既存のURLを全て書き換える必要があった
- SEOへの影響（リダイレクト設定）

---

### 7️⃣ フォールバックロジックの設計

「翻訳がない場合どうする？」という問題。

```typescript
// フォールバック優先順位
function getLocalizedText(multilingual, locale) {
  return multilingual[locale]      // 1. 要求された言語
      || multilingual['en']        // 2. 英語
      || multilingual['ja']        // 3. 日本語（マスター）
      || '';                       // 4. 空文字
}
```

**やらかし**: フォールバックを考えていなくて、翻訳がないと画面が壊れた

---

### 8️⃣ コンポーネント単位での修正が必要

```tsx
// Before: ハードコードされた日本語
<Button>トレードを作成</Button>
<p>該当する投稿が見つかりませんでした</p>

// After: next-intl対応
const t = useTranslations('common');
<Button>{t('createTrade')}</Button>
<p>{t('noPostsFound')}</p>
```

**実際の修正ファイル数**: 30ファイル以上（git statusより）

---

### 📊 想定 vs 現実

| 項目 | 最初の想定 | 実際 |
|------|-----------|------|
| 作業期間 | 1週間 | 6週間以上（継続中） |
| 翻訳ファイル | 1〜2個 | 100ファイル以上 |
| DB変更 | 不要 | 13テーブル、48カラム追加 |
| スクリプト作成 | 不要 | 10個以上（マイグレーション、インポート等） |
| 外部API | 不要 | Google Cloud Translate（申請待ち発生） |
| コスト | 0円 | 翻訳API費用 + 開発工数 |

---

### 💡 教訓

1. **最初から多言語を見据えた設計をすべき**
   - スキーマは `name_multilingual JSONB` で設計
   - ハードコードされた日本語は最初から避ける

2. **「UIテキストだけ」という認識は甘い**
   - DBに保存されるコンテンツも多言語化対象
   - ユーザー生成コンテンツはリアルタイム翻訳が必要

3. **カード名などの固有名詞は翻訳APIでは正確に訳せない**
   - 辞書データの準備が必須

4. **既存データが増えるほど移行コストが増大**
   - 早めにやらないと149,000件の地獄を見る