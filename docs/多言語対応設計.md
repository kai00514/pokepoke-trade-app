# 多言語対応設計ドキュメント

**作成日**: 2025-11-21  
**最終更新**: 2025-11-21  
**ステータス**: 設計フェーズ

## ⚠️ 重要な設計方針

### 既存カラムの保持
- **既存のカラム（`name`, `title`等）は削除・変更しない**
- 後方互換性を維持するため、既存カラムはそのまま残す
- 新しい多言語カラムを追加（`name_multilingual`, `title_multilingual`等）

### 移行期間の動作
1. **Phase 1**: 既存カラムと多言語カラムの両方が存在
2. **Phase 2**: アプリケーションを徐々に多言語カラムを使うように変更
3. **Phase 3**: 全ての機能が多言語カラムを使うように移行完了後、必要に応じて既存カラムを非推奨化

### カラム命名規則
- 既存カラム: `name`, `title`, `description` 等（そのまま維持）
- 多言語カラム: `{既存カラム名}_multilingual`
- 例: `name` → `name_multilingual`
- 例: `title` → `title_multilingual`

## 目次
1. [要件概要](#要件概要)
2. [対応言語](#対応言語)
3. [自動翻訳コスト分析](#自動翻訳コスト分析)
4. [データベーススキーマ設計](#データベーススキーマ設計)
5. [実装戦略](#実装戦略)
6. [移行計画](#移行計画)

---

## 要件概要

### 多言語対応の範囲

1. **UIテキスト**（ボタン、ラベル、メッセージ等）
   - フロントエンドの固定テキスト
   - バリデーションメッセージ
   - ナビゲーション要素

2. **ユーザー生成コンテンツ**
   - デッキタイトル・説明文
   - トレード投稿
   - コメント

3. **システムコンテンツ**
   - 記事・最新情報（info_pages）
   - デッキガイド（deck_pages）

4. **カードマスターデータ**
   - カード名
   - カード説明文
   - パック名

---

## 対応言語

| 言語 | 言語コード | 優先度 | 備考 |
|------|-----------|--------|------|
| 日本語 | `ja` | 最優先 | デフォルト言語 |
| 英語 | `en` | 高 | 国際展開の基本 |
| 中国語（簡体字） | `zh-CN` | 高 | アジア市場 |
| 中国語（繁体字） | `zh-TW` | 中 | 台湾・香港市場 |
| 韓国語 | `ko` | 高 | アジア市場 |

---

## 自動翻訳コスト分析

### 主要サービス比較

| サービス | コスト（100万文字あたり） | 無料枠 | 特徴 |
|---------|------------------------|--------|------|
| **AWS Translate** | $15 | 月200万文字 × 12ヶ月 | 最安値、Supabaseとの親和性高 |
| **Google Cloud Translation** | $20 | 月50万文字（継続） | 高品質、豊富な実績 |
| **DeepL API** | €20 ($22相当) | 月50万文字 | 最高品質、自然な翻訳 |

### コスト試算

#### 想定ボリューム（月間）
- ユーザー投稿（デッキ説明等）: 約10万文字
- 管理者コンテンツ（記事等）: 約5万文字
- カードデータ更新: 約2万文字
- **合計**: 約17万文字/月

#### 翻訳文字数（4言語展開の場合）
- 1言語から他4言語へ: 17万文字 × 4言語 = **68万文字/月**

#### 月額コスト試算

| サービス | 月額コスト | 年額コスト | 備考 |
|---------|-----------|-----------|------|
| **AWS Translate** | $0（無料枠内） | $0-120 | 初年度は無料枠で対応可能 |
| **Google Cloud** | $13.6 | $163 | 無料枠超過分: (68-50)万 × $20 |
| **DeepL API** | $15.4 | $185 | 無料枠超過分: (68-50)万 × €20 |

### 推奨アプローチ

#### フェーズ1: AWS Translate（コスト重視）
- **メリット**:
  - 初年度無料枠200万文字/月で余裕でカバー
  - Supabase（AWS基盤）との統合が容易
  - Edge Functions内で直接呼び出し可能

- **デメリット**:
  - 翻訳品質はDeepLに劣る場合がある
  - ゲーム用語の翻訳精度に課題の可能性

#### フェーズ2: ハイブリッド戦略（品質重視）
- **重要コンテンツ**: DeepL API
  - 公式記事・ガイド
  - 管理者が作成するコンテンツ

- **一般コンテンツ**: AWS Translate
  - ユーザー投稿
  - コメント

#### コスト削減施策

1. **キャッシング戦略**
   - 同一テキストの再翻訳を防ぐ
   - 翻訳履歴テーブルで管理

2. **バッチ翻訳**
   - リアルタイム翻訳ではなく、夜間バッチで処理
   - API呼び出し回数を削減

3. **翻訳スキップ条件**
   - 短文（10文字未満）はスキップ
   - 英数字のみの文字列はスキップ
   - URLやコードはスキップ

---

## データベーススキーマ設計

### 設計方針

| コンテンツタイプ | 管理方法 | 理由 |
|----------------|---------|------|
| **カードマスターデータ** | JSONB | 頻繁に参照、柔軟な構造が必要 |
| **管理者コンテンツ** | JSONB | 複数言語の同時管理が必要 |
| **ユーザー生成コンテンツ** | JSONB | 後から翻訳追加の可能性 |
| **UIテキスト** | i18nファイル（JSON） | フロントエンド側で管理 |

### スキーマ変更詳細

**重要な設計方針**:
- 既存カラムはそのまま維持（後方互換性のため）
- 新しい多言語カラムを追加（既存カラム名そのまま、`_i18n`サフィックスなし）
- JSONBフォーマット: `{"ja": "日本語", "en": "English", "zh-CN": "简体中文", "zh-TW": "繁體中文", "ko": "한국어"}`

---

#### 1. cards テーブル

```sql
-- 多言語カラムを追加（既存nameカラムはそのまま維持）
ALTER TABLE cards
ADD COLUMN name_multilingual JSONB,
ADD COLUMN poke2_name_multilingual JSONB;

-- 既存データを変換
UPDATE cards SET name_multilingual = jsonb_build_object('ja', name);
UPDATE cards SET poke2_name_multilingual = jsonb_build_object('ja', poke2_name) WHERE poke2_name IS NOT NULL;

-- インデックス
CREATE INDEX idx_cards_name_multilingual ON cards USING gin (name_multilingual);
```

---

#### 2. packs テーブル

```sql
ALTER TABLE packs
ADD COLUMN name_multilingual JSONB;

UPDATE packs SET name_multilingual = jsonb_build_object('ja', name);

CREATE INDEX idx_packs_name_multilingual ON packs USING gin (name_multilingual);
```

---

#### 3. deck_pages テーブル

```sql
ALTER TABLE deck_pages
ADD COLUMN title_multilingual JSONB,
ADD COLUMN deck_name_multilingual JSONB,
ADD COLUMN deck_description_multilingual JSONB,
ADD COLUMN section1_title_multilingual JSONB,
ADD COLUMN section2_title_multilingual JSONB,
ADD COLUMN section3_title_multilingual JSONB,
ADD COLUMN evaluation_title_multilingual JSONB,
ADD COLUMN tier_name_multilingual JSONB,
ADD COLUMN tier_descriptions_multilingual JSONB,
ADD COLUMN strengths_weaknesses_list_multilingual JSONB,
ADD COLUMN how_to_play_list_multilingual JSONB;

-- 既存データ変換（主要フィールドのみ例示）
UPDATE deck_pages SET
    title_multilingual = jsonb_build_object('ja', title),
    deck_name_multilingual = jsonb_build_object('ja', deck_name),
    deck_description_multilingual = jsonb_build_object('ja', deck_description);

CREATE INDEX idx_deck_pages_title_multilingual ON deck_pages USING gin (title_multilingual);
```

---

#### 4. info_pages テーブル

```sql
-- deck_pagesと同じ構造なので、同様のカラムを追加
ALTER TABLE info_pages
ADD COLUMN title_multilingual JSONB,
ADD COLUMN deck_name_multilingual JSONB,
ADD COLUMN deck_description_multilingual JSONB;
-- ... (deck_pagesと同様)
```

---

#### 5. decks テーブル

```sql
ALTER TABLE decks
ADD COLUMN title_multilingual JSONB,
ADD COLUMN description_multilingual JSONB,
ADD COLUMN tags_multilingual JSONB,
ADD COLUMN language_preference TEXT DEFAULT 'ja',
ADD COLUMN auto_translated BOOLEAN DEFAULT FALSE,
ADD COLUMN translation_status TEXT DEFAULT 'pending';

UPDATE decks SET
    title_multilingual = jsonb_build_object('ja', title),
    description_multilingual = jsonb_build_object('ja', description);

CREATE INDEX idx_decks_title_multilingual ON decks USING gin (title_multilingual);
CREATE INDEX idx_decks_translation_status ON decks (translation_status);
```

---

#### 6. trade_owned_list テーブル

```sql
ALTER TABLE trade_owned_list
ADD COLUMN list_name_multilingual JSONB;

UPDATE trade_owned_list SET list_name_multilingual = jsonb_build_object('ja', list_name);
```

---

#### 7. users テーブル（言語設定）

```sql
ALTER TABLE users
ADD COLUMN preferred_language TEXT DEFAULT 'ja',
ADD COLUMN language_detection_info JSONB DEFAULT '{}'::jsonb,
ADD COLUMN language_manually_set BOOLEAN DEFAULT FALSE,
ADD COLUMN language_updated_at TIMESTAMPTZ;

ALTER TABLE users
ADD CONSTRAINT check_preferred_language
CHECK (preferred_language IN ('ja', 'en', 'zh-CN', 'zh-TW', 'ko'));

CREATE INDEX idx_users_preferred_language ON users (preferred_language);
```

#### 5. trade_owned_list テーブル（トレードリスト）

**現在のスキーマ**:
```sql
CREATE TABLE trade_owned_list (
    id SERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    list_name VARCHAR(100) NOT NULL,
    card_ids INTEGER[],
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT check_card_ids_limit CHECK (array_length(card_ids, 1) <= 35),
    CONSTRAINT check_list_name_not_empty CHECK (length(trim(list_name)) > 0)
);
```

**新スキーマ**:
```sql
-- Step 1: 多言語化カラムを追加
ALTER TABLE trade_owned_list
ADD COLUMN list_name_i18n JSONB,
ADD COLUMN default_language TEXT DEFAULT 'ja';

-- Step 2: 既存データを変換
UPDATE trade_owned_list SET
    list_name_i18n = jsonb_build_object('ja', list_name)
WHERE list_name_i18n IS NULL;

-- Step 3: 制約を更新（将来的にlist_name_i18nをNOT NULLにする場合）
-- ALTER TABLE trade_owned_list ALTER COLUMN list_name_i18n SET NOT NULL;
```

**多言語化が必要なカラム**:
- `list_name` → `list_name_i18n` (JSONB): リスト名のみ

**多言語化不要なカラム**:
- `card_ids[]`: カードIDの配列（言語非依存）
- `user_id`: ユーザー参照

**特記事項**:
- ユーザー生成コンテンツなので自動翻訳を実施
- リスト名は短いため翻訳コストは低い

#### 6. packs テーブル（パックマスターデータ）

**現在のスキーマ**:
```sql
CREATE TABLE packs (
    id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    name TEXT NOT NULL,
    release_date DATE,
    total_cards SMALLINT,
    symbol_url TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**新スキーマ**:
```sql
-- Step 1: 多言語化カラムを追加
ALTER TABLE packs
ADD COLUMN name_i18n JSONB,
ADD COLUMN default_language TEXT DEFAULT 'ja';

-- Step 2: 既存データを変換
UPDATE packs SET
    name_i18n = jsonb_build_object('ja', name)
WHERE name_i18n IS NULL;

-- Step 3: インデックス
CREATE INDEX idx_packs_name_i18n_gin ON packs USING gin (name_i18n);
```

**多言語化が必要なカラム**:
- `name` → `name_i18n` (JSONB): {"ja": "拡張パック「幻のいる島」", "en": "Mythical Island", ...}

**多言語化不要なカラム**:
- `release_date`, `total_cards`: メタデータ
- `symbol_url`: 画像URL

---

### 多言語化フィールド一覧表

| テーブル | 既存カラム | 新しい多言語カラム | 備考 |
|---------|----------|------------------|------|
| **cards** | `name` | `name_multilingual` | カード名 |
| | `poke2_name` | `poke2_name_multilingual` | ポケモン名の別表記 |
| **packs** | `name` | `name_multilingual` | パック名 |
| **deck_pages** | `title` | `title_multilingual` | タイトル |
| | `deck_name` | `deck_name_multilingual` | デッキ名 |
| | `deck_description` | `deck_description_multilingual` | 説明 |
| | `section1_title` | `section1_title_multilingual` | セクション1タイトル |
| | `section2_title` | `section2_title_multilingual` | セクション2タイトル |
| | `section3_title` | `section3_title_multilingual` | セクション3タイトル |
| | `evaluation_title` | `evaluation_title_multilingual` | 評価タイトル |
| | `tier_name` | `tier_name_multilingual` | ティア名 |
| | `tier_descriptions[]` | `tier_descriptions_multilingual` | ティア説明（配列→JSONB） |
| | `strengths_weaknesses_list[]` | `strengths_weaknesses_list_multilingual` | 強み・弱み一覧 |
| | `how_to_play_list[]` | `how_to_play_list_multilingual` | 使い方一覧 |
| **info_pages** | （deck_pagesと同じ） | （deck_pagesと同じ） | 記事・最新情報 |
| **decks** | `title` | `title_multilingual` | デッキタイトル |
| | `description` | `description_multilingual` | デッキ説明 |
| | `tags[]` | `tags_multilingual` | タグ（配列→JSONB） |
| **trade_owned_list** | `list_name` | `list_name_multilingual` | リスト名 |
| **users** | - | `preferred_language` | ユーザーの言語設定（新規） |

**JSONBフォーマット例**:
```json
{
  "ja": "ピカチュウ",
  "en": "Pikachu",
  "zh-CN": "皮卡丘",
  "zh-TW": "皮卡丘",
  "ko": "피카츄"
}
```

**配列の多言語化例** (`tier_descriptions_multilingual`):
```json
{
  "ja": ["説明1", "説明2", "説明3"],
  "en": ["Description 1", "Description 2", "Description 3"],
  "zh-CN": ["描述1", "描述2", "描述3"],
  "ko": ["설명1", "설명2", "설명3"]
}
```

---

#### 8. translation_cache テーブル（新規作成）

翻訳のキャッシュとコスト管理のための新規テーブル:

```sql
CREATE TABLE translation_cache (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    source_text TEXT NOT NULL,
    source_language TEXT NOT NULL,
    target_language TEXT NOT NULL,
    translated_text TEXT NOT NULL,
    service_used TEXT NOT NULL, -- 'aws', 'deepl', 'google'
    created_at TIMESTAMPTZ DEFAULT NOW(),

    -- 同じテキスト・言語ペアの重複を防ぐ
    UNIQUE(source_text, source_language, target_language)
);

-- 高速検索用インデックス
CREATE INDEX idx_translation_cache_lookup
ON translation_cache (source_text, source_language, target_language);

-- 古いキャッシュの定期削除用
CREATE INDEX idx_translation_cache_created_at
ON translation_cache (created_at);
```

#### 9. translation_jobs テーブル（新規作成）

バッチ翻訳ジョブ管理用:

```sql
CREATE TABLE translation_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_type TEXT NOT NULL, -- 'deck', 'info_page', 'card', etc.
    entity_id TEXT NOT NULL,
    source_language TEXT NOT NULL,
    target_languages TEXT[] NOT NULL,
    status TEXT NOT NULL, -- 'pending', 'processing', 'completed', 'failed'
    priority INTEGER DEFAULT 0, -- 優先度（高いほど先に処理）
    service TEXT, -- 使用する翻訳サービス
    error_message TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ
);

CREATE INDEX idx_translation_jobs_status ON translation_jobs (status, priority DESC);
CREATE INDEX idx_translation_jobs_entity ON translation_jobs (entity_type, entity_id);
```

---

## 実装戦略

### フェーズ1: 基盤整備（2週間）

#### 1.1 データベース移行
- [ ] 翻訳キャッシュテーブル作成
- [ ] 翻訳ジョブテーブル作成
- [ ] 既存テーブルのバックアップ

#### 1.2 ヘルパー関数作成
```sql
-- JSONB多言語フィールドから指定言語の値を取得
CREATE OR REPLACE FUNCTION get_localized_text(
    jsonb_field JSONB,
    preferred_language TEXT DEFAULT 'ja',
    fallback_language TEXT DEFAULT 'ja'
)
RETURNS TEXT AS $$
BEGIN
    -- 希望言語が存在すればそれを返す
    IF jsonb_field ? preferred_language THEN
        RETURN jsonb_field->>preferred_language;
    END IF;

    -- フォールバック言語を返す
    IF jsonb_field ? fallback_language THEN
        RETURN jsonb_field->>fallback_language;
    END IF;

    -- どちらもなければ最初の値を返す
    RETURN jsonb_field->>jsonb_object_keys(jsonb_field) LIMIT 1;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- 使用例:
-- SELECT get_localized_text(name, 'en', 'ja') as name FROM cards;
```

#### 1.3 API設計
- [ ] Supabase Edge Functionsで翻訳API実装
- [ ] AWS Translate統合
- [ ] キャッシュ機構実装

### フェーズ2: カードマスターデータ移行（1週間）

#### 2.1 段階的移行戦略

```sql
-- Step 1: 多言語カラム追加（既存カラムはそのまま維持）
ALTER TABLE cards
ADD COLUMN name_multilingual JSONB,
ADD COLUMN poke2_name_multilingual JSONB;

ALTER TABLE packs
ADD COLUMN name_multilingual JSONB;

-- Step 2: 既存データを多言語フォーマットに変換
UPDATE cards SET name_multilingual = jsonb_build_object('ja', name);
UPDATE cards SET poke2_name_multilingual = jsonb_build_object('ja', poke2_name) 
WHERE poke2_name IS NOT NULL;

UPDATE packs SET name_multilingual = jsonb_build_object('ja', name);

-- Step 3: インデックス作成
CREATE INDEX idx_cards_name_multilingual ON cards USING gin (name_multilingual);
CREATE INDEX idx_packs_name_multilingual ON packs USING gin (name_multilingual);

-- Step 4: バッチ翻訳ジョブ登録
INSERT INTO translation_jobs (entity_type, entity_id, source_language, target_languages, priority)
SELECT 'card', id::TEXT, 'ja', ARRAY['en', 'zh-CN', 'zh-TW', 'ko'], 1
FROM cards;

INSERT INTO translation_jobs (entity_type, entity_id, source_language, target_languages, priority)
SELECT 'pack', id::TEXT, 'ja', ARRAY['en', 'zh-CN', 'zh-TW', 'ko'], 1
FROM packs;

-- 注意: 既存カラム(name等)は削除しない（後方互換性のため）
```

### フェーズ3: 管理者コンテンツ移行（1週間）

#### 3.1 info_pages移行
- [ ] 既存記事のバックアップ
- [ ] JSONBカラム追加
- [ ] 既存データ変換
- [ ] 自動翻訳実行

#### 3.2 deck_pages移行
- [ ] 同様の手順で実施

### フェーズ4: ユーザー生成コンテンツ対応（2週間）

#### 4.1 新規投稿の自動翻訳
- [ ] 投稿時にトリガー実装
- [ ] バックグラウンドジョブで翻訳
- [ ] 翻訳完了通知

#### 4.2 既存投稿の段階的移行
- [ ] 優先度の高いコンテンツから順次翻訳
- [ ] 閲覧数・いいね数ベースで優先順位付け

### フェーズ5: フロントエンド対応（2週間）

#### 5.1 i18n設定
- [ ] next-i18next または next-intl 導入
- [ ] 言語切り替えUI実装
- [ ] ブラウザ言語自動検出

#### 5.2 APIレスポンス対応
- [ ] クライアントの言語設定に基づく返却
- [ ] フォールバック処理

---

## 移行計画

### データ移行の優先順位

| 優先度 | コンテンツ | 理由 | 期間 |
|--------|-----------|------|------|
| 1 | カードマスターデータ | 最も参照される、データ量が比較的少ない | 1週間 |
| 2 | info_pages（記事） | 管理者が管理、品質重要 | 1週間 |
| 3 | deck_pages（ガイド） | 公式コンテンツ、SEO重要 | 1週間 |
| 4 | 人気デッキ（top 100） | ユーザー参照頻度高 | 3日 |
| 5 | その他ユーザーコンテンツ | 段階的に実施 | 継続 |

### ロールバック計画

各フェーズで以下を準備:
1. データベーススナップショット
2. 古いカラムの保持（移行完了まで）
3. 機能フラグによる新旧切り替え

### テスト計画

- [ ] 単体テスト: 翻訳関数
- [ ] 統合テスト: API連携
- [ ] E2Eテスト: 言語切り替え
- [ ] 負荷テスト: 翻訳APIの同時リクエスト数
- [ ] コストモニタリング: AWS Translateの使用量追跡

---

## 実際のスキーマに基づく修正サマリー

### ✅ 確認済みテーブル構造

以下のテーブルの実際のスキーマをSupabaseから取得し、設計を修正しました：

1. **cards**: `name`, `poke2_name`のみ多言語化。`description`カラムは存在しない
2. **packs**: `name`を多言語化。cardsテーブルから`pack_id`で参照される
3. **deck_pages**: 多数のテキストカラムを持つ。`title`, `deck_name`, `deck_description`等を多言語化
4. **info_pages**: deck_pagesと同一構造（用途が異なるだけ）
5. **decks**: ユーザー作成デッキ。`title`, `description`, `tags[]`を多言語化
6. **trade_owned_list**: `list_name`のみ多言語化
7. **users**: 言語設定カラムを追加予定

### ⚠️ 重要な発見

- **info_pagesとdeck_pagesは同じスキーマ**: 将来的にテーブル設計の見直しを推奨
- **cardsにdescriptionカラムは存在しない**: 元のドキュメントの想定と異なる
- **ユーザーはguest_nameもサポート**: 認証なしユーザーも投稿可能
- **既存の多言語対応**: `strengths_weaknesses_details`, `how_to_play_steps`等は既にJSONB

---

## 次のステップ

### 決定事項の確認が必要な項目

1. **翻訳サービスの選択**
   - AWS Translate（コスト重視） vs DeepL（品質重視） vs ハイブリッド

2. **既存データの翻訳範囲**
   - すべて翻訳 vs 人気コンテンツのみ vs 新規投稿のみ

3. **リアルタイム翻訳 vs バッチ翻訳**
   - ユーザー体験 vs コスト

4. **中国語の対応範囲**
   - 簡体字のみ vs 簡体字+繁体字

### 技術的検証が必要な項目

- [ ] AWS TranslateとSupabase Edge Functionsの連携テスト
- [ ] JSONB検索パフォーマンステスト
- [ ] 翻訳APIのレスポンスタイム計測
- [ ] 大量データの移行時間試算

---

## 付録

### JSONBクエリ例

```sql
-- 英語でカード名検索
SELECT * FROM cards
WHERE name->>'en' ILIKE '%Pikachu%';

-- 複数言語で検索（OR条件）
SELECT * FROM cards
WHERE name->>'ja' ILIKE '%ピカチュウ%'
   OR name->>'en' ILIKE '%Pikachu%';

-- 特定言語の存在チェック
SELECT * FROM cards
WHERE name ? 'en'; -- 英語版が存在するカード
```

### TypeScript型定義例

```typescript
// types/i18n.ts
export type SupportedLanguage = 'ja' | 'en' | 'zh-CN' | 'zh-TW' | 'ko';

export type MultilingualText = {
  [key in SupportedLanguage]?: string;
};

export type MultilingualArray = {
  [key in SupportedLanguage]?: string[];
};

// 実際のテーブル型定義
export interface Card {
  id: number;
  name: string; // 既存カラム（後方互換性のため維持）
  name_multilingual: MultilingualText; // 新しい多言語カラム
  poke2_name?: string;
  poke2_name_multilingual?: MultilingualText;
  image_url: string;
  thumb_url: string;
  category: string;
  type_code: string;
  rarity_code: string;
  pack_id?: number;
}

export interface Pack {
  id: number;
  name: string;
  name_multilingual: MultilingualText;
  release_date?: string;
  total_cards?: number;
  symbol_url?: string;
}

export interface Deck {
  id: string;
  title: string;
  title_multilingual: MultilingualText;
  description?: string;
  description_multilingual?: MultilingualText;
  tags?: string[];
  tags_multilingual?: MultilingualArray;
  language_preference: SupportedLanguage;
  auto_translated: boolean;
  translation_status: 'pending' | 'processing' | 'completed' | 'failed';
}

// ヘルパー関数
export function getLocalizedText(
  multilingualText: MultilingualText | string | null | undefined,
  preferredLanguage: SupportedLanguage,
  fallbackLanguage: SupportedLanguage = 'ja'
): string {
  if (!multilingualText) return '';
  if (typeof multilingualText === 'string') return multilingualText; // 旧形式対応
  
  // 優先言語を試す
  if (multilingualText[preferredLanguage]) {
    return multilingualText[preferredLanguage];
  }
  
  // フォールバック言語を試す
  if (multilingualText[fallbackLanguage]) {
    return multilingualText[fallbackLanguage];
  }
  
  // 最初に見つかった値を返す
  const firstValue = Object.values(multilingualText).find(v => v);
  return firstValue || '';
}

export function getLocalizedArray(
  multilingualArray: MultilingualArray | string[] | null | undefined,
  preferredLanguage: SupportedLanguage,
  fallbackLanguage: SupportedLanguage = 'ja'
): string[] {
  if (!multilingualArray) return [];
  if (Array.isArray(multilingualArray)) return multilingualArray; // 旧形式対応
  
  return multilingualArray[preferredLanguage] 
    || multilingualArray[fallbackLanguage] 
    || Object.values(multilingualArray).find(v => v) 
    || [];
}

// 使用例
const card: Card = {
  id: 1,
  name: 'ピカチュウ', // 既存
  name_multilingual: {
    ja: 'ピカチュウ',
    en: 'Pikachu',
    'zh-CN': '皮卡丘',
    ko: '피카츄'
  },
  // ...
};

const displayName = getLocalizedText(card.name_multilingual, 'en'); // "Pikachu"
```

### 見積もりツール

```typescript
// utils/translation-cost-estimator.ts
export function estimateTranslationCost(
  textLength: number,
  targetLanguages: number,
  service: 'aws' | 'google' | 'deepl'
): number {
  const totalChars = textLength * targetLanguages;
  const costPerMillionChars = {
    aws: 15,
    google: 20,
    deepl: 22
  };

  return (totalChars / 1_000_000) * costPerMillionChars[service];
}

// 使用例
const cost = estimateTranslationCost(1000, 4, 'aws');
console.log(`Estimated cost: $${cost.toFixed(4)}`);
```

---

**このドキュメントは継続的に更新されます**
