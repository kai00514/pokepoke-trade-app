# データベーススキーマ変更: 多言語対応

**作成日**: 2025-11-21
**ステータス**: 設計完了
**実装前の確認必須**

## 設計方針

### 1. 管理者作成コンテンツ
- **作成と同時に全言語翻訳**してJSONBで保存
- AWS Translate APIを使用
- 対応言語: ja, en, zh-CN, zh-TW, ko

### 2. ユーザー生成コンテンツ
- **バックグラウンドで自動翻訳**
- 翻訳ジョブテーブルで管理
- trade_commentsは例外（都度翻訳）

### 3. 既存カラムの保持
- **後方互換性のため既存カラムは削除しない**
- 新しい多言語カラムを追加: `{カラム名}_multilingual`

### 4. JSONBフォーマット
```json
{
  "ja": "日本語テキスト",
  "en": "English text",
  "zh-CN": "简体中文",
  "zh-TW": "繁體中文",
  "ko": "한국어"
}
```

---

## 1. カードマスターデータ

### cards テーブル

```sql
-- カード名と画像URLの多言語対応
ALTER TABLE cards
ADD COLUMN name_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
ADD COLUMN image_url_multilingual JSONB NOT NULL DEFAULT '{}'::jsonb;

-- 既存データ移行
UPDATE cards SET
    name_multilingual = jsonb_build_object('ja', name),
    image_url_multilingual = jsonb_build_object(
        'ja', image_url,
        'en', image_url,
        'zh-CN', image_url,
        'zh-TW', image_url,
        'ko', image_url
    );

-- インデックス
CREATE INDEX idx_cards_name_multilingual ON cards USING gin (name_multilingual);
CREATE INDEX idx_cards_image_url_multilingual ON cards USING gin (image_url_multilingual);

-- コメント
COMMENT ON COLUMN cards.name_multilingual IS 'カード名（全言語）。管理者が作成時に全言語を入力または自動翻訳';
COMMENT ON COLUMN cards.image_url_multilingual IS 'カード画像URL（言語・地域別で異なる可能性あり）';
```

**多言語化カラム**:
- ✅ `name` → `name_multilingual`
- ✅ `image_url` → `image_url_multilingual`
- ❌ `poke2_name` - 廃止予定のため対応不要

---

### packs テーブル

```sql
ALTER TABLE packs
ADD COLUMN name_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb;

UPDATE packs SET name_multilingual = jsonb_build_object('ja', name);

CREATE INDEX idx_packs_name_multilingual ON packs USING gin (name_multilingual);
```

---

## 2. デッキ・記事システム（管理者コンテンツ）

### deck_pages テーブル

**既存JSONB構造**:
```json
// deck_cards
[{"card_id": 4762, "pack_name": "未知なる水域", "card_count": 2, "display_order": 0}, ...]

// strengths_weaknesses_details
[{"title": "ベンチを並べて火力を出す", "image_urls": [...], "description": "<p>...</p>", "display_order": 1}, ...]

// how_to_play_steps
[{"title": "スイクンexをバトル場に出す", "image_urls": [...], "description": "<p>...</p>", "step_number": 1}, ...]
```

```sql
ALTER TABLE deck_pages
ADD COLUMN title_multilingual JSONB,
ADD COLUMN thumbnail_image_url_multilingual JSONB,
ADD COLUMN thumbnail_alt_multilingual JSONB,
ADD COLUMN deck_badge_multilingual JSONB,
ADD COLUMN section1_title_multilingual JSONB,
ADD COLUMN deck_name_multilingual JSONB,
ADD COLUMN energy_image_url_multilingual JSONB,
ADD COLUMN deck_cards_multilingual JSONB,
ADD COLUMN deck_description_multilingual JSONB,
ADD COLUMN evaluation_title_multilingual JSONB,
ADD COLUMN tier_rank_multilingual JSONB,
ADD COLUMN tier_name_multilingual JSONB,
ADD COLUMN tier_descriptions_multilingual JSONB,
ADD COLUMN section2_title_multilingual JSONB,
ADD COLUMN strengths_weaknesses_details_multilingual JSONB,
ADD COLUMN section3_title_multilingual JSONB,
ADD COLUMN how_to_play_steps_multilingual JSONB;

-- シンプルなテキストカラムの変換
UPDATE deck_pages SET
    title_multilingual = jsonb_build_object('ja', title),
    deck_name_multilingual = jsonb_build_object('ja', deck_name),
    deck_description_multilingual = jsonb_build_object('ja', deck_description),
    section1_title_multilingual = jsonb_build_object('ja', section1_title),
    section2_title_multilingual = jsonb_build_object('ja', section2_title),
    section3_title_multilingual = jsonb_build_object('ja', section3_title),
    evaluation_title_multilingual = jsonb_build_object('ja', evaluation_title),
    tier_rank_multilingual = jsonb_build_object('ja', tier_rank),
    tier_name_multilingual = jsonb_build_object('ja', tier_name);

-- 配列カラムの変換
UPDATE deck_pages SET
    tier_descriptions_multilingual = jsonb_build_object('ja', tier_descriptions);

-- JSONB（ネスト構造）の多言語化
UPDATE deck_pages SET
    deck_cards_multilingual = jsonb_build_object('ja', deck_cards),
    strengths_weaknesses_details_multilingual = jsonb_build_object('ja', strengths_weaknesses_details),
    how_to_play_steps_multilingual = jsonb_build_object('ja', how_to_play_steps);

-- インデックス
CREATE INDEX idx_deck_pages_title_multilingual ON deck_pages USING gin (title_multilingual);
CREATE INDEX idx_deck_pages_deck_cards_multilingual ON deck_pages USING gin (deck_cards_multilingual);
CREATE INDEX idx_deck_pages_strengths_multilingual ON deck_pages USING gin (strengths_weaknesses_details_multilingual);
CREATE INDEX idx_deck_pages_howto_multilingual ON deck_pages USING gin (how_to_play_steps_multilingual);
```

**多言語化カラム一覧**:
- ✅ テキスト: title, thumbnail_alt, deck_badge, section1/2/3_title, deck_name, deck_description, evaluation_title, tier_rank, tier_name
- ✅ URL: thumbnail_image_url, energy_image_url
- ✅ 配列: tier_descriptions
- ✅ JSONB（ネスト多言語化）: deck_cards, strengths_weaknesses_details, how_to_play_steps
- ❌ 数値: stat_accessibility, stat_speed, stat_power, stat_durability, stat_stability
- ❌ メタ: is_published, view_count, like_count, favorite_count, eval_value, eval_count
- ❌ ENUM: category

---

### info_pages テーブル

```sql
-- deck_pagesと同じ構造なので、同じカラムを追加
ALTER TABLE info_pages
ADD COLUMN title_multilingual JSONB,
ADD COLUMN thumbnail_image_url_multilingual JSONB,
-- ... (deck_pagesの全多言語カラムと同じ)
```

---

### info_articles テーブル

```sql
ALTER TABLE info_articles
ADD COLUMN slug_multilingual JSONB,
ADD COLUMN title_multilingual JSONB,
ADD COLUMN subtitle_multilingual JSONB,
ADD COLUMN excerpt_multilingual JSONB,
ADD COLUMN thumbnail_image_url_multilingual JSONB,
ADD COLUMN hero_image_url_multilingual JSONB,
ADD COLUMN tags_multilingual JSONB;

UPDATE info_articles SET
    slug_multilingual = jsonb_build_object('ja', slug),
    title_multilingual = jsonb_build_object('ja', title),
    subtitle_multilingual = jsonb_build_object('ja', subtitle),
    excerpt_multilingual = jsonb_build_object('ja', excerpt),
    thumbnail_image_url_multilingual = jsonb_build_object('ja', thumbnail_image_url),
    hero_image_url_multilingual = jsonb_build_object('ja', hero_image_url),
    tags_multilingual = jsonb_build_object('ja', tags);

CREATE INDEX idx_info_articles_title_multilingual ON info_articles USING gin (title_multilingual);
CREATE INDEX idx_info_articles_slug_multilingual ON info_articles USING gin (slug_multilingual);
CREATE INDEX idx_info_articles_tags_multilingual ON info_articles USING gin (tags_multilingual);
```

---

### info_article_blocks テーブル

**既存data構造例**:
```json
// heading
{"level": 2, "text": "見出しテキスト"}

// paragraph
{"text": "段落テキスト"}

// image
{"url": "画像URL", "caption": "キャプション"}

// list
{"style": "bulleted", "items": ["項目1", "項目2"]}

// table
{"headers": ["列1", "列2"], "rows": [["データ1", "データ2"]]}
```

```sql
ALTER TABLE info_article_blocks
ADD COLUMN data_multilingual JSONB;

-- dataフィールド全体を言語別に保持
UPDATE info_article_blocks SET
    data_multilingual = jsonb_build_object('ja', data);

CREATE INDEX idx_info_article_blocks_data_multilingual ON info_article_blocks USING gin (data_multilingual);

COMMENT ON COLUMN info_article_blocks.data_multilingual IS
'ブロックデータの多言語版。各言語でdataの完全な構造を保持: {"ja": {...}, "en": {...}, ...}';
```

**多言語化の実装方法**:
各ブロックタイプごとにdata内のテキストを翻訳:
- `heading`: `text`フィールドを翻訳
- `paragraph`: `text`フィールドを翻訳
- `list`: `items`配列の各要素を翻訳
- `table`: `headers`と`rows`の全テキストを翻訳
- etc.

---

## 3. ユーザー生成コンテンツ

### decks テーブル

```sql
ALTER TABLE decks
ADD COLUMN title_multilingual JSONB,
ADD COLUMN description_multilingual JSONB,
ADD COLUMN translation_status TEXT DEFAULT 'pending',
ADD COLUMN auto_translated_at TIMESTAMPTZ;

UPDATE decks SET
    title_multilingual = jsonb_build_object('ja', title),
    description_multilingual = jsonb_build_object('ja', COALESCE(description, ''));

CREATE INDEX idx_decks_title_multilingual ON decks USING gin (title_multilingual);
CREATE INDEX idx_decks_translation_status ON decks (translation_status);

ALTER TABLE decks
ADD CONSTRAINT check_translation_status
CHECK (translation_status IN ('pending', 'processing', 'completed', 'failed'));

COMMENT ON COLUMN decks.translation_status IS
'バックグラウンド翻訳ジョブの状態: pending（未処理）, processing（処理中）, completed（完了）, failed（失敗）';
```

**翻訳処理**:
- ユーザーがデッキを作成/更新時に`translation_jobs`テーブルにジョブ登録
- バックグラウンドワーカーが順次処理
- 完了後`translation_status`を更新

---

### trade_posts テーブル

```sql
ALTER TABLE trade_posts
ADD COLUMN title_multilingual JSONB,
ADD COLUMN comment_multilingual JSONB,
ADD COLUMN wanted_card_id_multilingual JSONB,
ADD COLUMN offered_card_id_multilingual JSONB,
ADD COLUMN translation_status TEXT DEFAULT 'pending';

UPDATE trade_posts SET
    title_multilingual = jsonb_build_object('ja', title),
    comment_multilingual = jsonb_build_object('ja', COALESCE(comment, '')),
    wanted_card_id_multilingual = jsonb_build_object('ja', wanted_card_id),
    offered_card_id_multilingual = jsonb_build_object('ja', offered_card_id);

CREATE INDEX idx_trade_posts_title_multilingual ON trade_posts USING gin (title_multilingual);
CREATE INDEX idx_trade_posts_translation_status ON trade_posts (translation_status);

ALTER TABLE trade_posts
ADD CONSTRAINT check_trade_translation_status
CHECK (translation_status IN ('pending', 'processing', 'completed', 'failed'));
```

**注意**: `wanted_card_id`と`offered_card_id`は既にJSONB配列:
```json
[
  {"id": 123, "name": "カード名", "imageUrl": "..."},
  ...
]
```
各カード情報の`name`も多言語化が必要。

---

### trade_owned_list テーブル

```sql
ALTER TABLE trade_owned_list
ADD COLUMN list_name_multilingual JSONB,
ADD COLUMN translation_status TEXT DEFAULT 'pending';

UPDATE trade_owned_list SET
    list_name_multilingual = jsonb_build_object('ja', list_name);

CREATE INDEX idx_trade_owned_list_translation_status ON trade_owned_list (translation_status);
```

---

### user_collages テーブル

```sql
ALTER TABLE user_collages
ADD COLUMN title1_multilingual JSONB,
ADD COLUMN title2_multilingual JSONB,
ADD COLUMN translation_status TEXT DEFAULT 'pending';

UPDATE user_collages SET
    title1_multilingual = jsonb_build_object('ja', title1),
    title2_multilingual = jsonb_build_object('ja', title2);

CREATE INDEX idx_user_collages_translation_status ON user_collages (translation_status);
```

---

### trade_comments テーブル（特殊: 都度翻訳）

**現状**:
- コメント数: 285,292件
- 総文字数: 約683万文字
- 全てを事前翻訳すると: 683万文字 × 4言語 = 約2,732万文字
- 初期翻訳コスト: $410（AWS Translate）

**方針**: **都度翻訳（オンデマンド翻訳）**

```sql
-- trade_commentsテーブルには多言語カラムを追加しない

COMMENT ON TABLE trade_comments IS
'コメントは都度翻訳方式。データベースには元の言語のみ保存。
表示時にユーザーが翻訳ボタンをクリックした場合のみ翻訳APIを呼び出す。
translation_cacheテーブルで翻訳結果をキャッシュして再利用。';
```

**実装方法**:
1. **UIに「翻訳」ボタンを追加**
2. クリック時に`/api/translate-comment`を呼び出し
3. APIは`translation_cache`を確認
   - キャッシュあり → すぐ返却
   - キャッシュなし → AWS Translateで翻訳 → キャッシュに保存 → 返却
4. **または**: ブラウザ標準の自動翻訳機能を利用

**メリット**:
- 初期コスト削減: $0
- 実際に閲覧されるコメントのみ翻訳
- ストレージ節約

---

## 4. 通知システム

### deck_notifications テーブル

```sql
ALTER TABLE deck_notifications
ADD COLUMN content_multilingual JSONB;

UPDATE deck_notifications SET
    content_multilingual = jsonb_build_object('ja', content);

CREATE INDEX idx_deck_notifications_content_multilingual ON deck_notifications USING gin (content_multilingual);
```

---

### trade_notifications テーブル

```sql
ALTER TABLE trade_notifications
ADD COLUMN content_multilingual JSONB;

UPDATE trade_notifications SET
    content_multilingual = jsonb_build_object('ja', content);

CREATE INDEX idx_trade_notifications_content_multilingual ON trade_notifications USING gin (content_multilingual);
```

**通知の多言語化**:
- 新規通知作成時にテンプレートから全言語版を生成
- 例: "{{user}}さんがコメントしました" → 各言語のテンプレート

---

## 5. その他

### tournaments テーブル

```sql
ALTER TABLE tournaments
ADD COLUMN title_multilingual JSONB,
ADD COLUMN benefit_multilingual JSONB;

UPDATE tournaments SET
    title_multilingual = jsonb_build_object('ja', title),
    benefit_multilingual = jsonb_build_object('ja', COALESCE(benefit, ''));

CREATE INDEX idx_tournaments_title_multilingual ON tournaments USING gin (title_multilingual);
```

---

### users テーブル

**変更不要** - 言語設定は別ドキュメント（user-language-detection-options.md）参照

---

## 6. サポートテーブル（新規作成）

### translation_cache テーブル

```sql
CREATE TABLE translation_cache (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    source_text TEXT NOT NULL,
    source_language TEXT NOT NULL,
    target_language TEXT NOT NULL,
    translated_text TEXT NOT NULL,
    service_used TEXT NOT NULL, -- 'aws', 'deepl', 'google'
    char_count INTEGER NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    last_accessed_at TIMESTAMPTZ DEFAULT NOW(),
    access_count INTEGER DEFAULT 1,

    -- 同じテキスト・言語ペアの重複を防ぐ
    UNIQUE(source_text, source_language, target_language)
);

-- 高速検索用インデックス
CREATE INDEX idx_translation_cache_lookup
ON translation_cache (source_text, source_language, target_language);

-- 古いキャッシュの定期削除用（例: 3ヶ月以上アクセスなし）
CREATE INDEX idx_translation_cache_last_accessed
ON translation_cache (last_accessed_at);

COMMENT ON TABLE translation_cache IS
'翻訳結果のキャッシュ。同じテキストの再翻訳を防ぎコストを削減。
定期的に古いキャッシュ（last_accessed_at < NOW() - INTERVAL ''3 months''）を削除。';
```

---

### translation_jobs テーブル

```sql
CREATE TABLE translation_jobs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_type TEXT NOT NULL, -- 'deck', 'trade_post', 'trade_owned_list', 'user_collage', etc.
    entity_id TEXT NOT NULL,
    source_language TEXT NOT NULL,
    target_languages TEXT[] NOT NULL,
    status TEXT NOT NULL DEFAULT 'pending', -- 'pending', 'processing', 'completed', 'failed'
    priority INTEGER DEFAULT 0, -- 優先度（高いほど先に処理）
    service TEXT, -- 使用する翻訳サービス
    error_message TEXT,
    retry_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,

    -- 同じエンティティの重複ジョブを防ぐ
    UNIQUE(entity_type, entity_id, status)
);

CREATE INDEX idx_translation_jobs_status ON translation_jobs (status, priority DESC, created_at);
CREATE INDEX idx_translation_jobs_entity ON translation_jobs (entity_type, entity_id);

COMMENT ON TABLE translation_jobs IS
'バックグラウンド翻訳ジョブの管理。
ユーザーがコンテンツを作成/更新時にジョブを登録し、
ワーカーが順次処理して各エンティティの*_multilingualカラムを更新する。';
```

---

## 7. マイグレーション実行順序

### Phase 1: マスターデータ（即座に実行可能）
```sql
-- 1. cards
ALTER TABLE cards ADD COLUMN name_multilingual JSONB ...;
-- 2. packs
ALTER TABLE packs ADD COLUMN name_multilingual JSONB ...;
```

### Phase 2: 管理者コンテンツ（段階的）
```sql
-- 1. deck_pages（約100-200件想定）
-- 2. info_pages（同上）
-- 3. info_articles（記事数による）
-- 4. info_article_blocks（記事×ブロック数）
-- 5. tournaments（少数）
```

### Phase 3: 通知システム
```sql
-- 1. deck_notifications
-- 2. trade_notifications
```

### Phase 4: ユーザーコンテンツ（最も時間がかかる）
```sql
-- 1. サポートテーブル作成
CREATE TABLE translation_cache ...;
CREATE TABLE translation_jobs ...;

-- 2. ユーザーテーブルに多言語カラム追加
ALTER TABLE decks ADD COLUMN title_multilingual JSONB ...;
ALTER TABLE trade_posts ADD COLUMN title_multilingual JSONB ...;
-- etc.

-- 3. 既存データの初期変換（日本語のみ）
UPDATE decks SET title_multilingual = jsonb_build_object('ja', title);

-- 4. 翻訳ジョブ登録（バッチで実行）
INSERT INTO translation_jobs (entity_type, entity_id, ...)
SELECT 'deck', id::TEXT, 'ja', ARRAY['en','zh-CN','zh-TW','ko'], 1
FROM decks
WHERE translation_status = 'pending'
LIMIT 1000; -- バッチサイズ
```

---

## 8. 実装チェックリスト

### データベース
- [ ] 全テーブルのALTER TABLE実行
- [ ] インデックス作成
- [ ] translation_cache, translation_jobs テーブル作成
- [ ] 既存データの初期変換（日本語のみ）

### API
- [ ] AWS Translate統合
- [ ] 翻訳APIエンドポイント作成 (`/api/translate`)
- [ ] バックグラウンドワーカー実装
- [ ] translation_cache の読み書き実装

### フロントエンド
- [ ] 多言語テキスト取得ヘルパー関数
- [ ] trade_commentsの「翻訳」ボタンUI
- [ ] 言語切り替え時のデータ再取得

### モニタリング
- [ ] 翻訳APIコスト追跡
- [ ] translation_jobs の処理状況ダッシュボード
- [ ] エラー通知設定

---

## 9. コスト見積もり（再計算）

### 初期翻訳コスト

| コンテンツ | 件数 | 平均文字数 | 総文字数 | 翻訳文字数（×4言語） | AWS Cost |
|-----------|------|----------|---------|-------------------|----------|
| cards | 2,000 | 10 | 20,000 | 80,000 | $1.20 |
| packs | 50 | 30 | 1,500 | 6,000 | $0.09 |
| deck_pages | 200 | 2,000 | 400,000 | 1,600,000 | $24.00 |
| info_articles | 100 | 1,500 | 150,000 | 600,000 | $9.00 |
| decks（人気上位1000） | 1,000 | 100 | 100,000 | 400,000 | $6.00 |
| trade_posts（最新1000） | 1,000 | 150 | 150,000 | 600,000 | $9.00 |
| **合計** | - | - | **821,500** | **3,286,000** | **$49.29** |

**trade_comments除外**: 都度翻訳方式により初期コスト $0

### 月間ランニングコスト（想定）

| 項目 | 月間文字数 | AWS Cost |
|------|-----------|----------|
| 新規ユーザーコンテンツ | 50,000 × 4 = 200,000 | $3.00 |
| 管理者コンテンツ更新 | 20,000 × 4 = 80,000 | $1.20 |
| trade_comments翻訳（オンデマンド） | 10,000 × 4 = 40,000 | $0.60 |
| **月額合計** | **320,000** | **$4.80** |

**年間コスト**: 約 $58

---

## まとめ

- **初期投資**: $49（trade_comments除く）
- **月額**: $5以下
- **trade_comments**: 都度翻訳で柔軟に対応
- **後方互換性**: 既存カラム維持で安全な移行
