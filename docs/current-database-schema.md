# ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

**ä½œæˆæ—¥**: 2025-11-25
**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Supabase PostgreSQL
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID**: oflucnwezzqqtxryonhf

---

## ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ | å¤šè¨€èªå¯¾å¿œå¿…è¦ |
|-----------|------|--------------|
| cards | ã‚«ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ | âœ… å¿…è¦ |
| packs | ãƒ‘ãƒƒã‚¯æƒ…å ± | âœ… å¿…è¦ |
| deck_pages | å…¬å¼ãƒ‡ãƒƒã‚­ã‚¬ã‚¤ãƒ‰ | âœ… å¿…è¦ |
| info_articles | æƒ…å ±è¨˜äº‹ | âœ… å¿…è¦ |
| info_article_blocks | è¨˜äº‹ãƒ–ãƒ­ãƒƒã‚¯ | âœ… å¿…è¦ |
| info_pages | æƒ…å ±ãƒšãƒ¼ã‚¸ | âœ… å¿…è¦ |
| tournaments | å¤§ä¼šæƒ…å ± | âœ… å¿…è¦ |
| decks | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒƒã‚­ | âœ… å¿…è¦ |
| trade_posts | ãƒˆãƒ¬ãƒ¼ãƒ‰æŠ•ç¨¿ | âœ… å¿…è¦ |
| user_collages | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ©ãƒ¼ã‚¸ãƒ¥ | âœ… å¿…è¦ |
| deck_comments | ãƒ‡ãƒƒã‚­ã‚³ãƒ¡ãƒ³ãƒˆ | âš ï¸ ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ç¿»è¨³ |
| trade_comments | ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆ | âš ï¸ ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ç¿»è¨³ |
| notifications | é€šçŸ¥ | âœ… å¿…è¦ |
| admin_users | ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ | âŒ ä¸è¦ |
| deck_cards | ãƒ‡ãƒƒã‚­ã‚«ãƒ¼ãƒ‰ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ« | âŒ ä¸è¦ |
| deck_favorites | ãƒ‡ãƒƒã‚­ãŠæ°—ã«å…¥ã‚Š | âŒ ä¸è¦ |
| deck_lists | ãƒ‡ãƒƒã‚­ãƒªã‚¹ãƒˆ | âŒ ä¸è¦ |
| deck_notifications | ãƒ‡ãƒƒã‚­é€šçŸ¥ | âŒ ä¸è¦ |
| contact_submissions | ãŠå•ã„åˆã‚ã› | âŒ ä¸è¦ |
| matching_survey_responses | ãƒãƒƒãƒãƒ³ã‚°èª¿æŸ»å›ç­” | âŒ ä¸è¦ |
| message_reactions | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | âŒ ä¸è¦ |
| trade_matches | ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒãƒƒãƒ | âŒ ä¸è¦ |
| trade_notifications | ãƒˆãƒ¬ãƒ¼ãƒ‰é€šçŸ¥ | âŒ ä¸è¦ |
| trade_owned_list | æ‰€æœ‰ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ | âŒ ä¸è¦ |
| trade_post_offered_cards | æä¾›ã‚«ãƒ¼ãƒ‰ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ« | âŒ ä¸è¦ |
| trade_post_wanted_cards | æ±‚ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ« | âŒ ä¸è¦ |
| users | ãƒ¦ãƒ¼ã‚¶ãƒ¼ | âŒ ä¸è¦ |

---

## 1. cardsï¼ˆã‚«ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE cards (
  id                 BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  name               TEXT NOT NULL,
  category           card_category NOT NULL,
  type_code          TEXT NOT NULL,
  rarity_code        card_rarity_code NOT NULL,
  pack_id            BIGINT REFERENCES packs(id) ON DELETE SET NULL,
  image_url          TEXT NOT NULL,
  thumb_url          TEXT NOT NULL,
  created_at         TIMESTAMPTZ NOT NULL DEFAULT now(),
  is_visible         BOOLEAN DEFAULT true,
  poke2_image_url    TEXT,
  poke2_name         TEXT,
  game8_image_url    TEXT,
  col_1              TEXT,
  col_2              TEXT,
  col_3              TEXT,  -- ãƒ‘ãƒƒã‚¯è­˜åˆ¥å­
  col_4              TEXT,  -- ã‚«ãƒ¼ãƒ‰ç•ªå·
  col_5              TEXT   -- ãƒ•ãƒ«ID
);

CREATE INDEX idx_cards_is_visible ON cards(is_visible);
CREATE INDEX idx_cards_name ON cards USING GIN(to_tsvector('simple', name));
CREATE INDEX idx_cards_pack ON cards(pack_id);
CREATE INDEX idx_cards_type ON cards(type_code, rarity_code);
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´

```sql
-- JSONB ã‚«ãƒ©ãƒ è¿½åŠ 
ALTER TABLE cards ADD COLUMN name_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb;
ALTER TABLE cards ADD COLUMN image_url_multilingual JSONB NOT NULL DEFAULT '{}'::jsonb;

-- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ JSONB ã«å¤‰æ›
UPDATE cards SET
  name_multilingual = jsonb_build_object('ja', name),
  image_url_multilingual = jsonb_build_object(
    'ja', image_url,
    'en', COALESCE(game8_image_url, image_url)
  );

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_cards_name_multilingual ON cards USING GIN(name_multilingual);
CREATE INDEX idx_cards_image_multilingual ON cards USING GIN(image_url_multilingual);
```

---

## 2. packsï¼ˆãƒ‘ãƒƒã‚¯æƒ…å ±ï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE packs (
  id           BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  name         TEXT NOT NULL,
  release_date DATE,
  total_cards  SMALLINT,
  symbol_url   TEXT,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at   TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´

```sql
ALTER TABLE packs ADD COLUMN name_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb;
ALTER TABLE packs ADD COLUMN symbol_url_multilingual JSONB DEFAULT '{}'::jsonb;

UPDATE packs SET
  name_multilingual = jsonb_build_object('ja', name),
  symbol_url_multilingual = jsonb_build_object('ja', symbol_url);

CREATE INDEX idx_packs_name_multilingual ON packs USING GIN(name_multilingual);
```

---

## 3. deck_pagesï¼ˆå…¬å¼ãƒ‡ãƒƒã‚­ã‚¬ã‚¤ãƒ‰ï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE deck_pages (
  id                           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title                        TEXT NOT NULL,
  last_updated                 TIMESTAMPTZ DEFAULT now(),
  comment_count                INTEGER DEFAULT 0,
  thumbnail_image_url          TEXT,
  thumbnail_alt                TEXT,
  deck_badge                   TEXT,
  section1_title               TEXT NOT NULL,
  deck_name                    TEXT NOT NULL,
  energy_type                  TEXT NOT NULL,
  energy_image_url             TEXT,
  deck_cards                   JSONB DEFAULT '[]'::jsonb,
  deck_description             TEXT,
  evaluation_title             TEXT NOT NULL,
  tier_rank                    TEXT NOT NULL,
  tier_name                    TEXT NOT NULL,
  tier_descriptions            TEXT[] DEFAULT '{}',
  stat_accessibility           INTEGER CHECK (stat_accessibility BETWEEN 1 AND 5),
  stat_speed                   INTEGER CHECK (stat_speed BETWEEN 1 AND 5),
  stat_power                   INTEGER CHECK (stat_power BETWEEN 1 AND 5),
  stat_durability              INTEGER CHECK (stat_durability BETWEEN 1 AND 5),
  stat_stability               INTEGER CHECK (stat_stability BETWEEN 1 AND 5),
  section2_title               TEXT NOT NULL,
  strengths_weaknesses_list    TEXT[] DEFAULT '{}',
  strengths_weaknesses_details JSONB DEFAULT '[]'::jsonb,
  section3_title               TEXT NOT NULL,
  how_to_play_list             TEXT[] DEFAULT '{}',
  how_to_play_steps            JSONB DEFAULT '[]'::jsonb,
  is_published                 BOOLEAN DEFAULT false,
  view_count                   INTEGER DEFAULT 0,
  like_count                   INTEGER DEFAULT 0,
  created_at                   TIMESTAMPTZ DEFAULT now(),
  updated_at                   TIMESTAMPTZ DEFAULT now(),
  category                     deck_category DEFAULT 'featured',
  favorite_count               INTEGER NOT NULL DEFAULT 0,
  eval_value                   NUMERIC(3,2) DEFAULT 0.00,
  eval_count                   INTEGER DEFAULT 0
);

CREATE INDEX idx_deck_pages_category ON deck_pages(category);
CREATE INDEX idx_deck_pages_deck_cards ON deck_pages USING GIN(deck_cards);
CREATE INDEX idx_deck_pages_published ON deck_pages(is_published, created_at DESC);
CREATE INDEX idx_deck_pages_title ON deck_pages USING GIN(to_tsvector('simple', title));
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´ï¼ˆ17ã‚«ãƒ©ãƒ ï¼‰

```sql
-- 17ã‚«ãƒ©ãƒ ã®å¤šè¨€èªåŒ–
ALTER TABLE deck_pages
  ADD COLUMN title_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
  ADD COLUMN deck_name_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
  ADD COLUMN deck_description_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN evaluation_title_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
  ADD COLUMN tier_name_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
  ADD COLUMN tier_descriptions_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN section1_title_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
  ADD COLUMN section2_title_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
  ADD COLUMN section3_title_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
  ADD COLUMN strengths_weaknesses_list_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN strengths_weaknesses_details_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN how_to_play_list_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN how_to_play_steps_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN thumbnail_alt_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN deck_badge_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN thumbnail_image_url_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN energy_image_url_multilingual JSONB DEFAULT '{}'::jsonb;

-- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å¤‰æ›
UPDATE deck_pages SET
  title_multilingual = jsonb_build_object('ja', title),
  deck_name_multilingual = jsonb_build_object('ja', deck_name),
  -- ... (ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚åŒæ§˜)
;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆGINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 4å€‹ï¼‰
CREATE INDEX idx_deck_pages_title_multilingual ON deck_pages USING GIN(title_multilingual);
CREATE INDEX idx_deck_pages_strengths_weaknesses_multilingual ON deck_pages USING GIN(strengths_weaknesses_details_multilingual);
CREATE INDEX idx_deck_pages_how_to_play_multilingual ON deck_pages USING GIN(how_to_play_steps_multilingual);
CREATE INDEX idx_deck_pages_deck_name_multilingual ON deck_pages USING GIN(deck_name_multilingual);
```

---

## 4. info_articlesï¼ˆæƒ…å ±è¨˜äº‹ï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE info_articles (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug                CITEXT UNIQUE,
  title               TEXT NOT NULL,
  subtitle            TEXT,
  excerpt             TEXT,
  thumbnail_image_url TEXT,
  hero_image_url      TEXT,
  category            TEXT NOT NULL DEFAULT 'news',
  tags                TEXT[] NOT NULL DEFAULT '{}',
  is_published        BOOLEAN NOT NULL DEFAULT false,
  published_at        TIMESTAMPTZ NOT NULL DEFAULT now(),
  pinned              BOOLEAN NOT NULL DEFAULT false,
  priority            INTEGER NOT NULL DEFAULT 0,
  view_count          BIGINT NOT NULL DEFAULT 0,
  like_count          BIGINT NOT NULL DEFAULT 0,
  favorite_count      BIGINT NOT NULL DEFAULT 0,
  comment_count       BIGINT NOT NULL DEFAULT 0,
  author_id           UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at          TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX info_articles_idx_cat_pin_pri_pub ON info_articles(category, pinned DESC, priority DESC, published_at DESC);
CREATE INDEX info_articles_idx_pub_time ON info_articles(is_published, published_at DESC);
CREATE INDEX info_articles_idx_tags_gin ON info_articles USING GIN(tags);
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´ï¼ˆ6ã‚«ãƒ©ãƒ ï¼‰

```sql
ALTER TABLE info_articles
  ADD COLUMN title_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
  ADD COLUMN subtitle_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN excerpt_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN thumbnail_image_url_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN hero_image_url_multilingual JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN tags_multilingual JSONB DEFAULT '{}'::jsonb;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆGINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 2å€‹ï¼‰
CREATE INDEX idx_info_articles_title_multilingual ON info_articles USING GIN(title_multilingual);
CREATE INDEX idx_info_articles_tags_multilingual ON info_articles USING GIN(tags_multilingual);
```

---

## 5. info_article_blocksï¼ˆè¨˜äº‹ãƒ–ãƒ­ãƒƒã‚¯ï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE info_article_blocks (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  article_id    UUID NOT NULL REFERENCES info_articles(id) ON DELETE CASCADE,
  display_order INTEGER NOT NULL,
  type          TEXT NOT NULL,
  data          JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(article_id, display_order)
);

CREATE INDEX info_article_blocks_type_idx ON info_article_blocks(type);

-- Constraint: type ã‚’åˆ¶é™
CHECK (type IN ('heading', 'paragraph', 'rich-text', 'image', 'list', 'table',
                'flexible-table', 'key-value-table', 'callout', 'toc',
                'latest-info', 'divider', 'related-links', 'evaluation',
                'cards-table', 'card-display-table', 'media-gallery',
                'pickup', 'button'))
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´ï¼ˆ1ã‚«ãƒ©ãƒ ï¼‰

```sql
ALTER TABLE info_article_blocks
  ADD COLUMN data_multilingual JSONB NOT NULL DEFAULT '{"ja":{}}'::jsonb;

UPDATE info_article_blocks SET
  data_multilingual = jsonb_build_object('ja', data);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆGINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 1å€‹ï¼‰
CREATE INDEX idx_info_article_blocks_data_multilingual ON info_article_blocks USING GIN(data_multilingual);
```

---

## 6. info_pagesï¼ˆæƒ…å ±ãƒšãƒ¼ã‚¸ï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE info_pages (
  -- deck_pages ã¨åŒã˜æ§‹é€ 
  id                           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title                        TEXT NOT NULL,
  -- ... (deck_pages ã¨åŒä¸€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤šæ•°)
);
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´

**info_pages ã¯ deck_pages ã¨åŒã˜æ§‹é€ ã®ãŸã‚ã€deck_pages ã¨åŒã˜17ã‚«ãƒ©ãƒ ã®å¤šè¨€èªåŒ–ãŒå¿…è¦**

---

## 7. tournamentsï¼ˆå¤§ä¼šæƒ…å ±ï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE tournaments (
  id           BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  title        TEXT NOT NULL,
  event_date   TIMESTAMP NOT NULL,
  is_online    BOOLEAN DEFAULT true,
  benefit      TEXT DEFAULT '',
  detail_url   TEXT DEFAULT '',
  is_published BOOLEAN DEFAULT true
);
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´ï¼ˆ2ã‚«ãƒ©ãƒ ï¼‰

```sql
ALTER TABLE tournaments
  ADD COLUMN title_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
  ADD COLUMN benefit_multilingual JSONB DEFAULT '{}'::jsonb;

UPDATE tournaments SET
  title_multilingual = jsonb_build_object('ja', title),
  benefit_multilingual = jsonb_build_object('ja', benefit);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆGINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 1å€‹ï¼‰
CREATE INDEX idx_tournaments_title_multilingual ON tournaments USING GIN(title_multilingual);
```

---

## 8. decksï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒƒã‚­ï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE decks (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title             TEXT NOT NULL,
  description       TEXT,
  user_id           UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  guest_name        TEXT,
  is_public         BOOLEAN NOT NULL DEFAULT true,
  tags              TEXT[] DEFAULT '{}',
  thumbnail_card_id INTEGER REFERENCES cards(id) ON DELETE SET NULL,
  created_at        TIMESTAMPTZ NOT NULL DEFAULT timezone('utc', now()),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT timezone('utc', now()),
  like_count        INTEGER NOT NULL DEFAULT 0,
  favorite_count    INTEGER NOT NULL DEFAULT 0,
  view_count        INTEGER NOT NULL DEFAULT 0,
  comment_count     INTEGER NOT NULL DEFAULT 0,
  CHECK (
    (user_id IS NOT NULL AND guest_name IS NULL) OR
    (user_id IS NULL AND guest_name IS NOT NULL)
  )
);

CREATE INDEX idx_decks_created_at ON decks(created_at DESC);
CREATE INDEX idx_decks_is_public ON decks(is_public);
CREATE INDEX idx_decks_user_id ON decks(user_id);
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´ï¼ˆ2ã‚«ãƒ©ãƒ ï¼‰

```sql
ALTER TABLE decks
  ADD COLUMN title_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
  ADD COLUMN description_multilingual JSONB DEFAULT '{}'::jsonb;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆGINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 1å€‹ï¼‰
CREATE INDEX idx_decks_title_multilingual ON decks USING GIN(title_multilingual);
```

---

## 9. trade_postsï¼ˆãƒˆãƒ¬ãƒ¼ãƒ‰æŠ•ç¨¿ï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE trade_posts (
  id               UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  title            TEXT NOT NULL,
  owner_id         UUID,
  custom_id        TEXT,
  comment          TEXT,
  status           TEXT NOT NULL DEFAULT 'OPEN'
                   CHECK (status IN ('OPEN', 'MATCHED', 'COMPLETED', 'CANCELLED')),
  created_at       TIMESTAMPTZ DEFAULT now(),
  updated_at       TIMESTAMPTZ DEFAULT now(),
  is_authenticated BOOLEAN NOT NULL DEFAULT false,
  guest_name       TEXT,
  g8_post_id       TEXT,
  wanted_card_id   JSONB DEFAULT '[]'::jsonb CHECK (jsonb_typeof(wanted_card_id) = 'array'),
  offered_card_id  JSONB DEFAULT '[]'::jsonb CHECK (jsonb_typeof(offered_card_id) = 'array'),
  g8_flg           BOOLEAN
);

CREATE INDEX idx_trade_posts_offered_card_id_gin ON trade_posts USING GIN(offered_card_id);
CREATE INDEX idx_trade_posts_wanted_card_id_gin ON trade_posts USING GIN(wanted_card_id);
CREATE INDEX idx_trade_posts_status ON trade_posts(status);
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´ï¼ˆ2ã‚«ãƒ©ãƒ ï¼‰

```sql
ALTER TABLE trade_posts
  ADD COLUMN title_multilingual JSONB NOT NULL DEFAULT '{"ja":""}'::jsonb,
  ADD COLUMN comment_multilingual JSONB DEFAULT '{}'::jsonb;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆGINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 1å€‹ï¼‰
CREATE INDEX idx_trade_posts_title_multilingual ON trade_posts USING GIN(title_multilingual);
```

---

## 10. user_collagesï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ©ãƒ¼ã‚¸ãƒ¥ï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE user_collages (
  id                   UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id              UUID NOT NULL REFERENCES auth.users(id),
  title1               TEXT NOT NULL DEFAULT 'æ±‚ã‚ã‚‹ã‚«ãƒ¼ãƒ‰',
  card_ids_1           BIGINT[] NOT NULL,
  title2               TEXT NOT NULL DEFAULT 'è­²ã‚Œã‚‹ã‚«ãƒ¼ãƒ‰',
  card_ids_2           BIGINT[] NOT NULL,
  created_at           TIMESTAMP DEFAULT now(),
  updated_at           TIMESTAMP DEFAULT now(),
  collage_image_url    TEXT,
  collage_storage_path TEXT
);

CREATE INDEX idx_user_id ON user_collages(user_id);
CREATE INDEX idx_user_id_created ON user_collages(user_id, created_at DESC);
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´ï¼ˆ2ã‚«ãƒ©ãƒ ï¼‰

```sql
ALTER TABLE user_collages
  ADD COLUMN title1_multilingual JSONB NOT NULL DEFAULT '{"ja":"æ±‚ã‚ã‚‹ã‚«ãƒ¼ãƒ‰"}'::jsonb,
  ADD COLUMN title2_multilingual JSONB NOT NULL DEFAULT '{"ja":"è­²ã‚Œã‚‹ã‚«ãƒ¼ãƒ‰"}'::jsonb;

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆGINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ãªã— - ã‚¿ã‚¤ãƒˆãƒ«ã¯å›ºå®šãƒ•ãƒ¬ãƒ¼ã‚ºã®ãŸã‚ï¼‰
```

---

## 11. deck_commentsï¼ˆãƒ‡ãƒƒã‚­ã‚³ãƒ¡ãƒ³ãƒˆï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE deck_comments (
  id           UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  deck_id      UUID NOT NULL,
  user_id      UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  parent_id    UUID REFERENCES deck_comments(id) ON DELETE CASCADE,
  content      TEXT NOT NULL,
  created_at   TIMESTAMPTZ DEFAULT now(),
  updated_at   TIMESTAMPTZ DEFAULT now(),
  user_name    VARCHAR(255),
  comment_type TEXT NOT NULL DEFAULT 'deck'
               CHECK (comment_type IN ('deck', 'deck_page'))
);

CREATE INDEX idx_comments_deck ON deck_comments(deck_id);
CREATE INDEX idx_deck_comments_type_deck_id ON deck_comments(comment_type, deck_id);
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´

**ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ç¿»è¨³**: `content` ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¿»è¨³APIçµŒç”±ã§è¡¨ç¤ºã€‚JSONBä¿å­˜ã¯ä¸è¦ã€‚

---

## 12. trade_commentsï¼ˆãƒˆãƒ¬ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE trade_comments (
  id                    UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  post_id               UUID NOT NULL,
  user_id               TEXT,
  content               TEXT NOT NULL,
  parent_id             UUID,
  is_guest              BOOLEAN DEFAULT false,
  guest_id              TEXT,
  created_at            TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at            TIMESTAMPTZ DEFAULT now(),
  is_edited             BOOLEAN DEFAULT false,
  is_hidden             BOOLEAN DEFAULT false,
  edited_at             TIMESTAMPTZ,
  user_name             TEXT,
  is_deleted            BOOLEAN DEFAULT false,
  guest_name            TEXT,
  thread_comment_number TEXT,
  game8_flg             SMALLINT DEFAULT 0,
  game8_comp_flg        SMALLINT DEFAULT 1,
  g8_comment_id         TEXT,
  trainer_id            TEXT,
  friend_name           TEXT
);

CREATE INDEX idx_trade_comments_post_id ON trade_comments(post_id);
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´

**ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ç¿»è¨³**: `content` ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¿»è¨³APIçµŒç”±ã§è¡¨ç¤ºã€‚JSONBä¿å­˜ã¯ä¸è¦ã€‚

---

## 13. notificationsï¼ˆé€šçŸ¥ï¼‰

### ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE notifications (
  id         BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
  user_id    UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  type       TEXT NOT NULL,
  payload    JSONB NOT NULL,
  is_read    BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_notifications_user_read ON notifications(user_id, is_read);
```

### å¤šè¨€èªåŒ–ã«å¿…è¦ãªå¤‰æ›´ï¼ˆ1ã‚«ãƒ©ãƒ ï¼‰

```sql
ALTER TABLE notifications
  ADD COLUMN payload_multilingual JSONB NOT NULL DEFAULT '{"ja":{}}'::jsonb;

UPDATE notifications SET
  payload_multilingual = jsonb_build_object('ja', payload);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆGINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: 1å€‹ï¼‰
CREATE INDEX idx_notifications_payload_multilingual ON notifications USING GIN(payload_multilingual);
```

---

## ğŸ“Š å¤šè¨€èªåŒ–ã‚µãƒãƒªãƒ¼

### å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«: 13å€‹

| ãƒ†ãƒ¼ãƒ–ãƒ«å | è¿½åŠ ã‚«ãƒ©ãƒ æ•° | GINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ•° | BTREEã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ•° | ç¿»è¨³æˆ¦ç•¥ |
|-----------|------------|----------------|-------------------|---------|
| cards | 2 | 2 | 0 | CSV import |
| packs | 2 | 1 | 0 | Admin-created |
| deck_pages | 17 | 4 | 0 | Admin-created |
| info_articles | 6 | 2 | 0 | Admin-created |
| info_article_blocks | 1 | 1 | 0 | Admin-created |
| info_pages | 17 | 4 | 0 | Admin-created |
| tournaments | 2 | 1 | 0 | Admin-created |
| decks | 2 | 1 | 0 | Background |
| trade_posts | 2 | 1 | 0 | Background |
| user_collages | 2 | 0 | 0 | Background |
| deck_comments | - | - | - | On-demand |
| trade_comments | - | - | - | On-demand |
| notifications | 1 | 1 | 0 | Background |
| **åˆè¨ˆ** | **54** | **18** | **0** | - |

**æ³¨**: å¤šè¨€èªã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã‚µãƒãƒªãƒ¼ã§ã¯66ã‚«ãƒ©ãƒ ãƒ»53ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã—ãŸãŒã€ã‚³ãƒ¡ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ç¿»è¨³ã«å¤‰æ›´ã—ãŸãŸã‚å®Ÿéš›ã¯54ã‚«ãƒ©ãƒ ãƒ»18ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ”§ è£œåŠ©ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ä½œæˆãŒå¿…è¦ï¼‰

### translation_cacheï¼ˆç¿»è¨³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰

```sql
CREATE TABLE translation_cache (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source_text     TEXT NOT NULL,
  source_language VARCHAR(10) NOT NULL,
  target_language VARCHAR(10) NOT NULL,
  translated_text TEXT NOT NULL,
  service_used    VARCHAR(50) NOT NULL DEFAULT 'google-translate',
  char_count      INTEGER NOT NULL,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(source_text, source_language, target_language)
);

CREATE INDEX idx_translation_cache_lookup
  ON translation_cache(source_text, source_language, target_language);
CREATE INDEX idx_translation_cache_created
  ON translation_cache(created_at DESC);
```

### translation_jobsï¼ˆç¿»è¨³ã‚¸ãƒ§ãƒ–ï¼‰

```sql
CREATE TABLE translation_jobs (
  id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  table_name      TEXT NOT NULL,
  record_id       TEXT NOT NULL,
  column_name     TEXT NOT NULL,
  source_language VARCHAR(10) NOT NULL DEFAULT 'ja',
  target_language VARCHAR(10) NOT NULL,
  status          TEXT NOT NULL DEFAULT 'pending'
                  CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
  error_message   TEXT,
  attempts        INTEGER NOT NULL DEFAULT 0,
  created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
  started_at      TIMESTAMPTZ,
  completed_at    TIMESTAMPTZ,
  UNIQUE(table_name, record_id, column_name, target_language)
);

CREATE INDEX idx_translation_jobs_status
  ON translation_jobs(status, created_at);
CREATE INDEX idx_translation_jobs_table_record
  ON translation_jobs(table_name, record_id);
```

---

## ğŸ“ å‚™è€ƒ

- **ENUMå‹**: `card_category`, `card_rarity_code`, `deck_category` ãªã©ã®ENUMå‹ã¯æ—¢å­˜ã®ã¾ã¾ç¶­æŒ
- **Full Text Search**: æ—¥æœ¬èªã®å…¨æ–‡æ¤œç´¢ã¯ `to_tsvector('simple', ...)` ã‚’ä½¿ç”¨
- **RLS (Row Level Security)**: æ—¢å­˜ã®ãƒãƒªã‚·ãƒ¼ã¯ç¶­æŒã—ã€å¤šè¨€èªã‚«ãƒ©ãƒ ã«å¯¾ã—ã¦ã‚‚åŒã˜ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨
- **Triggers**: `updated_at` è‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼ã¯æ—¢å­˜ã®ã¾ã¾ç¶­æŒ

---

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: ã“ã®ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’ã‚‚ã¨ã«ã€Phase 2ã®å®Œå…¨ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³SQLã‚’ä½œæˆã—ã¾ã™ã€‚
