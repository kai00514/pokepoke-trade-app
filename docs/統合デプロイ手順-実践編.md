# 統合デプロイ手順 - 実践編

**目的**: `feature/i18n-test-environment` ブランチをSupabase + Vercelでテスト環境としてデプロイ

**所要時間**: 約15分

---

## ステップ1: Supabaseプレビューブランチの作成（5分）

### 1.1 現在の画面で設定

スクリーンショットの画面で以下を入力:

```
プレビューブランチ名: dev-feature-i18n
```

**重要**:
- ✅ 「GitHubブランチと同期する」を**有効**にする
- ✅ 設定ボタンをクリックしてGitHubブランチを選択

### 1.2 GitHubブランチの選択

「設定」をクリック後:

```
GitHubブランチ: feature/i18n-test-environment
```

を選択

### 1.3 PITR（ポイントインタイムリカバリ）

- ✅ 「PITRを有効化する」にチェック（推奨）
- これにより本番データベースの特定時点に戻せます

### 1.4 作成実行

1. 「ブランチを作成」ボタンをクリック
2. 数分待つ（プログレスバーが表示されます）
3. 完了したら次のステップへ

---

## ステップ2: Supabase認証情報の取得（2分）

### 2.1 作成されたブランチを開く

```
Supabase Dashboard > Branches > dev-feature-i18n
```

### 2.2 認証情報をコピー

1. **Settings > API** を開く

2. 以下をコピーしてメモ帳に保存:

```env
# Supabase Preview Branch
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...
```

---

## ステップ3: ローカル環境変数の設定（2分）

### 3.1 環境変数ファイルを作成

```bash
# プロジェクトルートで実行
cat > .env.local << 'EOF'
# Supabase Preview Branch
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...

# Environment Identifier
NEXT_PUBLIC_ENV=preview
EOF
```

**または手動で編集**:

```bash
# .env.local を開く
code .env.local

# 上記の内容を貼り付け
# xxxxx と eyJhbGc... をステップ2.2でコピーした値に置き換え
```

### 3.2 .gitignoreの確認

```bash
# .env.local が無視されることを確認
cat .gitignore | grep .env.local

# 出力: .env.local が表示されればOK
```

---

## ステップ4: Gitブランチをプッシュ（2分）

### 4.1 現在の状態を確認

```bash
git status
```

### 4.2 未コミットの変更があればコミット

```bash
# 変更がある場合
git add .
git commit -m "chore: update environment configuration for preview"
```

### 4.3 リモートにプッシュ

```bash
# 初回プッシュ（既にプッシュ済みの場合はスキップ）
git push -u origin feature/i18n-test-environment

# または通常のプッシュ
git push
```

**確認**:
```bash
# プッシュ成功を確認
git log --oneline -1
git branch -vv
```

---

## ステップ5: Vercel環境変数の設定（3分）

### 5.1 Vercel Dashboardを開く

```
https://vercel.com/dashboard
```

### 5.2 プロジェクトを選択

```
pokepoke-trade-app プロジェクトをクリック
```

### 5.3 環境変数を追加

1. **Settings > Environment Variables** を開く

2. **新しい環境変数を追加**:

#### 変数1: NEXT_PUBLIC_SUPABASE_URL

```
Name:        NEXT_PUBLIC_SUPABASE_URL
Value:       https://xxxxx.supabase.co  (ステップ2.2の値)
Environment: Preview ✓ (チェック)
             Production ✗
             Development ✗
Git Branch:  feature/i18n-test-environment
```

「Save」をクリック

#### 変数2: NEXT_PUBLIC_SUPABASE_ANON_KEY

```
Name:        NEXT_PUBLIC_SUPABASE_ANON_KEY
Value:       eyJhbGc...  (ステップ2.2の値)
Environment: Preview ✓ (チェック)
             Production ✗
             Development ✗
Git Branch:  feature/i18n-test-environment
```

「Save」をクリック

#### 変数3: NEXT_PUBLIC_ENV

```
Name:        NEXT_PUBLIC_ENV
Value:       preview
Environment: Preview ✓ (チェック)
             Production ✗
             Development ✗
Git Branch:  feature/i18n-test-environment
```

「Save」をクリック

---

## ステップ6: Vercel デプロイの確認（3分）

### 6.1 デプロイページを開く

```
Vercel Dashboard > Deployments タブ
```

### 6.2 自動デプロイの確認

GitHubにプッシュした時点で、自動的にデプロイが開始されているはずです。

**デプロイステータス**:
- 🟡 Building... - ビルド中
- 🟢 Ready - デプロイ完了
- 🔴 Error - エラー発生

### 6.3 プレビューURLを取得

デプロイ完了後:

1. デプロイをクリック
2. 「Visit」ボタンをクリック、またはURLをコピー

```
例: https://pokepoke-trade-app-git-feature-i18n-xxxxx.vercel.app
```

---

## ステップ7: 動作確認（5分）

### 7.1 プレビューURLにアクセス

ブラウザで以下を開く:

```
https://pokepoke-trade-app-git-feature-i18n-xxxxx.vercel.app
```

### 7.2 基本動作の確認

- [ ] トップページが表示される
- [ ] ナビゲーションが表示される
- [ ] エラーがコンソールに出ていない

### 7.3 Supabase接続の確認

以下を試す:

1. **ログインページにアクセス**
   ```
   https://your-preview-url.vercel.app/auth/login
   ```

2. **既存アカウントでログイン試行**
   - Supabase Branchは本番DBのコピーなので、本番と同じユーザーが存在します
   - ログインできればSupabase接続成功

3. **または新規登録を試す**
   - テスト用アカウントを作成
   - 確認メールが届くか確認

### 7.4 トラブルシューティング

#### エラー: Supabase connection failed

```bash
# Vercelの環境変数を再確認
Vercel Dashboard > Settings > Environment Variables

# 以下を確認:
# 1. NEXT_PUBLIC_SUPABASE_URL が正しい
# 2. NEXT_PUBLIC_SUPABASE_ANON_KEY が正しい
# 3. Environment が "Preview" になっている
# 4. Git Branch が "feature/i18n-test-environment" になっている
```

#### エラー: Page not found

```bash
# デプロイログを確認
Vercel Dashboard > Deployments > 該当デプロイ > Logs

# ビルドエラーがないか確認
```

---

## ✅ 完了チェックリスト

### Supabase
- [ ] プレビューブランチ作成完了: `dev-feature-i18n`
- [ ] GitHubブランチと同期済み: `feature/i18n-test-environment`
- [ ] 認証情報を取得済み

### ローカル
- [ ] .env.local に認証情報を設定
- [ ] ローカルで動作確認（オプション）

### Git
- [ ] ブランチをリモートにプッシュ済み
- [ ] コミット履歴が正常

### Vercel
- [ ] Preview環境変数を3つ設定済み
  - NEXT_PUBLIC_SUPABASE_URL
  - NEXT_PUBLIC_SUPABASE_ANON_KEY
  - NEXT_PUBLIC_ENV
- [ ] Git Branchを指定済み: `feature/i18n-test-environment`
- [ ] デプロイ完了
- [ ] プレビューURLで動作確認済み

---

## 📝 重要な情報を記録

### 環境情報

```
=== Supabase Preview Branch ===
Branch名: dev-feature-i18n
Project URL: https://_____.supabase.co
作成日時: 2025-11-22

=== Vercel Preview ===
プレビューURL: https://_____.vercel.app
Git Branch: feature/i18n-test-environment
デプロイ日時: 2025-11-22

=== GitHub ===
Branch: feature/i18n-test-environment
最新コミット: [コミットハッシュ]
```

---

## 🎯 次のステップ

### すぐにできること

1. **ローカルでi18n実装を開始**
   ```bash
   # パッケージインストール
   pnpm add next-intl

   # ドキュメント参照
   docs/Supabase-Branch活用テスト環境構築.md
   ```

2. **変更をプッシュして自動デプロイをテスト**
   ```bash
   # 何か変更を加える（例: README.md）
   echo "\n## Test" >> README.md

   git add README.md
   git commit -m "test: verify auto deployment"
   git push

   # Vercel Dashboardで自動デプロイを確認
   ```

3. **i18n設定ファイルの作成**
   - `i18n.ts`
   - `middleware.ts`
   - `app/[locale]/layout.tsx`

### 今後の作業フロー

```
1. ローカルで開発
   ↓
2. git commit
   ↓
3. git push
   ↓
4. Vercel自動デプロイ（約3-5分）
   ↓
5. プレビューURLで確認
   ↓
6. 問題なければ次の機能へ
```

---

## 🔧 便利なコマンド

### ローカル開発

```bash
# 開発サーバー起動
pnpm dev

# Supabase Preview Branchに接続確認
curl https://xxxxx.supabase.co/rest/v1/
```

### Vercelデプロイ確認

```bash
# Vercel CLIインストール（オプション）
npm i -g vercel

# ログインして接続
vercel login
vercel link

# リアルタイムログを確認
vercel logs --follow
```

### Git操作

```bash
# 現在のブランチを確認
git branch

# リモートと同期
git fetch origin
git status

# 最新のコミットを確認
git log --oneline -5
```

---

## 📞 トラブルシューティング

### 問題1: Vercelデプロイが開始されない

**原因**: GitHubとVercelの連携が切れている

**解決策**:
```
1. Vercel Dashboard > Settings > Git
2. "Reconnect to GitHub" をクリック
3. リポジトリを再接続
```

### 問題2: 環境変数が反映されない

**原因**: デプロイ時に環境変数が読み込まれていない

**解決策**:
```
1. Settings > Environment Variables で再確認
2. "Preview" 環境にチェックが入っているか確認
3. 再デプロイを実行:
   - Deployments > 該当デプロイ > "..." > Redeploy
```

### 問題3: Supabase接続エラー

**原因**: 認証情報が間違っている

**解決策**:
```
1. Supabase Dashboard > dev-feature-i18n > Settings > API
2. 認証情報を再コピー
3. Vercelの環境変数を更新
4. 再デプロイ
```

---

## 🎉 成功したら

テスト環境のデプロイ完了です！

次は以下のドキュメントでi18n実装を進めましょう:

- 📖 [Supabase-Branch活用テスト環境構築.md](./Supabase-Branch活用テスト環境構築.md)
- 📝 [テスト環境構築チェックリスト.md](./テスト環境構築チェックリスト.md)

---

**作成者**: Claude Code
**作成日**: 2025-11-22
